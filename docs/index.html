<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="height=device-height, width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vuetify@latest/dist/vuetify.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@latest/css/materialdesignicons.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Kosugi|M+PLUS+1p&amp;subset=japanese">

        <script src="https://cdn.jsdelivr.net/npm/vue@latest/dist/vue.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuex@latest/dist/vuex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue-router@latest/dist/vue-router.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/vuetify@latest/dist/vuetify.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/axios@latest/dist/axios.min.js"></script>

        <title>AboutMe</title>
    </head>

    <body>
        <div id="vue">
            <v-app>
                <v-app-bar app dark height="52" color="light-blue darken-2">
                    <v-app-bar-nav-icon v-if="$vuetify.breakpoint.xsOnly" @click="toggleNav(true)"></v-app-bar-nav-icon>

                    <v-btn text class="text-subtitle-1 pl-1 override_button_case" @click="$router.push('/')">
                        <v-avatar size="44">
                            <v-img src=""></v-img>
                        </v-avatar>

                        <v-toolbar-title>AboutMe</v-toolbar-title>
                    </v-btn>
                </v-app-bar>

                <v-navigation-drawer app disable-resize-watcher v-model="nav">
                    <v-toolbar dark height="52" color="light-blue darken-2">
                        <v-icon class="pr-3">mdi-menu</v-icon>

                        <v-toolbar-title>Menu</v-toolbar-title>

                        <v-spacer></v-spacer>

                        <v-btn icon @click="toggleNav(false)">
                            <v-icon large>mdi-close</v-icon>
                        </v-btn>
                    </v-toolbar>
                </v-navigation-drawer>

                <v-main>
                    <router-view></router-view>
                </v-main>
            </v-app>
        </div>
    </body>

    <style>
        .v-application{
            font-family: "M PLUS 1p", "Kosugi" !important;
        }
        .override_full_height{
            height: calc(100vh - 52px);
        }
        .override_button_case{
            text-transform: unset;
        }
    </style>

    <script>
        const loadComponent = axios.create({
            method: "get",
            baseURL: "./components",
            responseType: "text",
            transformResponse(data){
                const component = new DOMParser().parseFromString(data, "text/html");

                const template = component.head.getElementsByTagName("template")[0]?.innerHTML || "";
                const script = component.head.getElementsByTagName("script")[0]?.innerText || "";
                const style = component.head.getElementsByTagName("style")[0];

                const mixin = new Function(script.trim().replace(/^(export|module).*?(?={)/i, "return"));
                let body = template.trim().replace(/^<template>/i, "").replace(/<\/template>$/i, "");
                let css = "";

                if(template && style){
                    if(style.getAttributeNames().some(attribute => attribute === "scoped")){
                        const dom = new DOMParser().parseFromString(body, "text/html");
                        const selectors = Array.from(new Set(style.innerText.match(/\.[a-zA-Z_][a-zA-Z0-9_\-]*/ig)));
                        const scope = Array.from(crypto.getRandomValues(new Uint8Array(6))).map(byte => byte.toString(16)).join("");

                        for(const selector of selectors){
                            const undot = selector.replace(/^\./, "");

                            for(const {classList} of dom.body.getElementsByClassName(undot)){
                                classList.replace(undot, `${undot}_${scope}`);
                            }
                        }

                        body = dom.body.innerHTML;
                        css = selectors.reduce((style, selector) => style.replace(new RegExp(selector, "ig"), `${selector}_${scope}`), style.innerText);
                    }
                    else{
                        css = style.innerText;
                    }
                }

                return {
                    template(){
                        return template ? body : "";
                    },
                    script(){
                        return script ? mixin() : {};
                    },
                    style(){
                        return style ? css : "";
                    }
                };
            }
        });

        const loadMap = axios.create({
            method: "get",
            baseURL: "./components",
            responseType: "json",
            transformResponse({parents, paths}){
                return Object.entries(paths).map(([virtual, physical]) => [`${parents.virtual}${virtual}`, `${parents.physical}${physical}`]);
            }
        });

        const vue = (async()=>{
            const maps = [
                "/paths.json",
                "/blog/paths.json"
            ];

            const paths = [];
            for await(const {data} of maps.map(map => loadMap(map))){
                paths.push(...data);
            }

            return new Vue({
                el: "#vue",
                vuetify: new Vuetify(),

                data(){
                    return {
                        nav: false
                    };
                },

                methods: {
                    toggleNav(state){
                        this.nav = state;
                    }
                },

                router: new VueRouter({
                    routes: paths.map(([virtual, physical])=>{
                        return {
                            path: virtual,
                            async component(res){
                                const {data} = await loadComponent(`${physical}.vue`);

                                const style = document.createElement("style");
                                style.innerText = data.style();
                                document.head.appendChild(style);

                                res({
                                    template: data.template(),
                                    mixins: [data.script()]
                                });
                            }
                        };
                    })
                })
            });
        })();
    </script>
</html>